{% extends 'base.html' %}

{% block title %}Inventory - Simple ERP{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="fs-3"><i class="bi bi-inbox"></i> Inventory Management</h1>
    </div>
</div>

<div class="row mt-3">
    <div class="col-md-6">
        <div class="card small-box shadow-sm">
            <div class="card-header py-2">
                <h6 class="mb-0">Add New Item</h6>
            </div>
            <div class="card-body p-3">
                <form method="POST" novalidate>
                    <div class="mb-2">
                        <label for="name" class="form-label small">Item Name</label>
                        <input type="text" class="form-control form-control-sm" id="name" name="name" required
                               placeholder="Enter item name" value="{{ request.form.name if request.form else '' }}">
                    </div>
                    <div class="mb-2">
                        <label for="quantity" class="form-label small">Quantity</label>
                        <input type="number" class="form-control form-control-sm" id="quantity" name="quantity" min="0" required
                               placeholder="Enter quantity" value="{{ request.form.quantity if request.form else '' }}">
                    </div>
                    <div class="mb-2">
                        <label for="price" class="form-label small">Price per Unit (₹)</label>
                        <input type="number" step="0.01" class="form-control form-control-sm" id="price" name="price" min="0" required
                               placeholder="e.g., 100.00" value="{{ request.form.price if request.form else '' }}">
                    </div>
                    <div class="mb-2">
                        <label for="description" class="form-label small">Description (Optional)</label>
                        <textarea class="form-control form-control-sm" id="description" name="description" rows="2"
                                  placeholder="Enter description">{{ request.form.description if request.form else '' }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-success btn-sm">Add Item</button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card small-box shadow-sm">
            <div class="card-header py-2">
                <h6 class="mb-0">Quick Stats</h6>
            </div>
            <div class="card-body p-3 small">
                <p class="mb-1">Total Items: {{ items|length if items else 0 }}</p>
                <p class="mb-0">Total Stock Value: ₹{{ total_stock_value or 0 }}</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card small-box shadow-sm">
            <div class="card-header py-2">
                <h6 class="mb-0">Inventory List</h6>
            </div>
            <div class="card-body p-2">
                {% if items %}
                    <table class="table table-striped table-sm align-middle">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Quantity</th>
                                <th>Price (₹)</th>
                                <th>Value (₹)</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                                <tr>
                                    <td>{{ item.id }}</td>
                                    <td>{{ item.name }}</td>
                                    <td><span class="badge bg-{{ 'danger' if item.quantity == 0 else 'success' }}">{{ item.quantity }}</span></td>
                                    <td>₹{{ "%.2f"|format(item.price) }}</td>
                                    <td>₹{{ "%.2f"|format(item.total_value()) }}</td>
                                    <td>{{ item.description or 'N/A' }}</td>
                                    <td>
                                        <!-- Edit Button -->
                                        <button 
                                            type="button" 
                                            class="btn btn-sm btn-outline-primary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#editItemModal"
                                            data-id="{{ item.id }}"
                                            data-name="{{ item.name }}"
                                            data-quantity="{{ item.quantity }}"
                                            data-price="{{ item.price }}"
                                            data-description="{{ item.description }}">
                                            Edit
                                        </button>

                                        <!-- Delete Button -->
                                        <form method="POST" action="{{ url_for('delete_item', item_id=item.id) }}" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                onclick="return confirm('Are you sure you want to delete this item?');">
                                                Delete
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted small">No items in inventory yet. Add one above!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ==================== Edit Item Modal ==================== -->
<div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content small-box">
      <div class="modal-header py-2">
        <h6 class="modal-title" id="editItemModalLabel">Edit Item</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editItemForm" method="POST">
        <div class="modal-body p-3">
          <div class="mb-2">
            <label class="form-label small">Name</label>
            <input type="text" class="form-control form-control-sm" id="editName" name="name" required>
          </div>
          <div class="mb-2">
            <label class="form-label small">Quantity</label>
            <input type="number" class="form-control form-control-sm" id="editQuantity" name="quantity" required>
          </div>
          <div class="mb-2">
            <label class="form-label small">Price (₹)</label>
            <input type="number" step="0.01" class="form-control form-control-sm" id="editPrice" name="price" required>
          </div>
          <div class="mb-2">
            <label class="form-label small">Description</label>
            <textarea class="form-control form-control-sm" id="editDescription" name="description" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer py-2">
          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ==================== JS for Edit Modal ==================== -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  var editModal = document.getElementById('editItemModal');
  editModal.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var id = button.getAttribute('data-id');
    var name = button.getAttribute('data-name');
    var quantity = button.getAttribute('data-quantity');
    var price = button.getAttribute('data-price');
    var description = button.getAttribute('data-description');

    var form = document.getElementById('editItemForm');
    form.action = '/edit_item/' + id;

    document.getElementById('editName').value = name;
    document.getElementById('editQuantity').value = quantity;
    document.getElementById('editPrice').value = price;
    document.getElementById('editDescription').value = description || '';
  });
});
</script>
{% endblock %}
